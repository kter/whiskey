# Whiskey App Infrastructure

AWS CDK (TypeScript) ã‚’ä½¿ç”¨ã—ãŸã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£å®šç¾©ã§ã™ã€‚

## ğŸ“‹ æ¦‚è¦

ã“ã®ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã¯ä»¥ä¸‹ã®AWSãƒªã‚½ãƒ¼ã‚¹ã‚’æ§‹ç¯‰ã—ã¾ã™ï¼š

### ğŸ—ï¸ æ§‹ç¯‰ã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹

- **VPC**: ãƒ‘ãƒ–ãƒªãƒƒã‚¯/ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆæ§‹æˆ
- **Cognito**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ« + ã‚¢ãƒ—ãƒªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
- **S3**: 
  - ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼ç”»åƒä¿å­˜ç”¨ãƒã‚±ãƒƒãƒˆï¼ˆç½²åä»˜ãURLã€CORSè¨­å®šæ¸ˆã¿ï¼‰
  - Nuxt.js SPAç”¨Webãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒã‚±ãƒƒãƒˆ
- **CloudFront**: SPAé…ä¿¡ç”¨CDN
- **DynamoDB**: 
  - Whiskeysãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆGSI: NameIndexï¼‰
  - Reviewsãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆGSI: UserDateIndexï¼‰
- **IAM**: Lambda/ECSå®Ÿè¡Œãƒ­ãƒ¼ãƒ«ã€GitHub Actionsç”¨ãƒ­ãƒ¼ãƒ«
- **Secrets Manager**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿå¯†æƒ…å ±ç®¡ç†

### ğŸŒ ç’°å¢ƒ

- **dev**: é–‹ç™ºç’°å¢ƒï¼ˆã‚³ã‚¹ãƒˆæœ€é©åŒ–ï¼‰
- **prod**: æœ¬ç•ªç’°å¢ƒï¼ˆé«˜å¯ç”¨æ€§ã€ãƒ‡ãƒ¼ã‚¿ä¿æŒï¼‰

## ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### å‰ææ¡ä»¶

- Node.js 18+
- AWS CLI
- AWS ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨é©åˆ‡ãªæ¨©é™

### 1. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
cd infra
npm install
```

### 2. AWSèªè¨¼è¨­å®š

```bash
aws configure
# ã¾ãŸã¯
export AWS_PROFILE=your-profile
```

### 3. CDK Bootstrapï¼ˆåˆå›ã®ã¿ï¼‰

```bash
npx cdk bootstrap
```

## ğŸ”§ ãƒ‡ãƒ—ãƒ­ã‚¤

### ç°¡å˜ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# é–‹ç™ºç’°å¢ƒ
./scripts/deploy.sh dev

# æœ¬ç•ªç’°å¢ƒ
./scripts/deploy.sh prod
```

### è©³ç´°ã‚ªãƒ—ã‚·ãƒ§ãƒ³

```bash
# å·®åˆ†ç¢ºèªã—ã¦ã‹ã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤
./scripts/deploy.sh dev --diff

# ç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—
./scripts/deploy.sh dev --no-confirm

# ã‚¹ã‚¿ãƒƒã‚¯å‰Šé™¤
./scripts/deploy.sh dev --destroy
```

### æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# é–‹ç™ºç’°å¢ƒ
npm run build
npx cdk deploy -c env=dev

# æœ¬ç•ªç’°å¢ƒ
npm run build
npx cdk deploy -c env=prod
```

## ğŸ“Š å‡ºåŠ›å€¤ã®ç¢ºèª

```bash
# ã‚¹ã‚¿ãƒƒã‚¯å‡ºåŠ›ã®ç¢ºèª
aws cloudformation describe-stacks \
  --stack-name WhiskeyApp-Dev \
  --query 'Stacks[0].Outputs[*].[OutputKey,OutputValue]' \
  --output table
```

## ğŸ”— GitHub Actionsè¨­å®š

### 1. OIDC ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®è¨­å®š

```bash
# ä¸€åº¦ã ã‘å®Ÿè¡ŒãŒå¿…è¦
aws iam create-open-id-connect-provider \
  --url https://token.actions.githubusercontent.com \
  --client-id-list sts.amazonaws.com \
  --thumbprint-list 6938fd4d98bab03faadb97b34396831e3780aea1
```

### 2. GitHub Secretsè¨­å®š

```bash
# ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒ­ãƒ¼ãƒ«ARNã‚’GitHub Secretsã«è¨­å®š
AWS_ROLE_ARN: <GitHubActionsRoleArn>
```

### 3. ãƒªãƒã‚¸ãƒˆãƒªåã®åˆ¶é™

`lib/whiskey-infra-stack.ts` ã®ä»¥ä¸‹ã®è¡Œã‚’ä¿®æ­£ï¼š

```typescript
'token.actions.githubusercontent.com:sub': 'repo:your-username/your-repo:*'
```

## ğŸŒ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç’°å¢ƒå¤‰æ•°

ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã€ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ã‚’Nuxt.jsã‚¢ãƒ—ãƒªã§ä½¿ç”¨ã§ãã¾ã™ï¼š

```bash
NUXT_PUBLIC_USER_POOL_ID=<UserPoolId>
NUXT_PUBLIC_USER_POOL_CLIENT_ID=<UserPoolClientId>
NUXT_PUBLIC_REGION=ap-northeast-1
NUXT_PUBLIC_IMAGES_BUCKET=<ImagesBucketName>
NUXT_PUBLIC_API_BASE_URL=<API_URL>
NUXT_PUBLIC_ENVIRONMENT=dev|prod
```

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            Internet                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
                â”‚CloudFront â”‚
                â”‚Distributionâ”‚
                â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                      â”‚
                â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚S3 (WebApp)â”‚      â”‚  S3 (Images)â”‚
                â”‚  Bucket   â”‚      â”‚   Bucket    â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                VPC (10.0.0.0/16)        â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                         â”‚
â”‚  â”‚        Public Subnets               â”‚ â”‚                         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚                         â”‚
â”‚  â”‚  â”‚   AZ-1a      â”‚  â”‚   AZ-1c      â”‚ â”‚ â”‚                         â”‚
â”‚  â”‚  â”‚10.0.0.0/24   â”‚  â”‚10.0.1.0/24   â”‚ â”‚ â”‚                         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                         â”‚
â”‚  â”‚       Private Subnets               â”‚ â”‚                         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚                         â”‚
â”‚  â”‚  â”‚   AZ-1a      â”‚  â”‚   AZ-1c      â”‚ â”‚ â”‚                         â”‚
â”‚  â”‚  â”‚10.0.2.0/24   â”‚  â”‚10.0.3.0/24   â”‚ â”‚ â”‚                         â”‚
â”‚  â”‚  â”‚              â”‚  â”‚              â”‚ â”‚ â”‚                         â”‚
â”‚  â”‚  â”‚ Lambda/ECS   â”‚  â”‚ Lambda/ECS   â”‚ â”‚ â”‚                         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                  â”‚           â”‚
        â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
        â”‚DynamoDB â”‚         â”‚Cognito â”‚ â”‚Secrets  â”‚
        â”‚ Tables  â”‚         â”‚UserPoolâ”‚ â”‚Manager  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ è¨­å®šã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### æœ¬ç•ªãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®š

`config/environments.ts` ã‚’ç·¨é›†ï¼š

```typescript
prod: {
  domain: 'your-actual-domain.com',
  allowedOrigins: ['https://your-actual-domain.com'],
  // SSLè¨¼æ˜æ›¸ARNï¼ˆRoute53 + ACMä½¿ç”¨æ™‚ï¼‰
  // certificateArn: 'arn:aws:acm:...',
}
```

### ç’°å¢ƒå›ºæœ‰ãƒªã‚½ãƒ¼ã‚¹è¨­å®š

```typescript
// lib/whiskey-infra-stack.ts
natGateways: environment === 'prod' ? 2 : 1,  // æœ¬ç•ªã¯å†—é•·åŒ–
removalPolicy: environment === 'prod' 
  ? cdk.RemovalPolicy.RETAIN    // æœ¬ç•ªã¯ãƒ‡ãƒ¼ã‚¿ä¿æŒ
  : cdk.RemovalPolicy.DESTROY   // é–‹ç™ºã¯å‰Šé™¤
```

## ğŸ“ é‹ç”¨ã‚³ãƒãƒ³ãƒ‰

### å·®åˆ†ç¢ºèª

```bash
npx cdk diff -c env=dev
```

### ãƒªã‚½ãƒ¼ã‚¹ä¸€è¦§

```bash
npx cdk list -c env=dev
```

### CloudFormationãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ

```bash
npx cdk synth -c env=dev
```

### ã‚¹ã‚¿ãƒƒã‚¯å‰Šé™¤

```bash
npx cdk destroy -c env=dev
```

## ğŸ” ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

1. **Bootstrapæœªå®Ÿè¡Œ**
   ```bash
   npx cdk bootstrap
   ```

2. **æ¨©é™ä¸è¶³**
   - AdministratorAccess ã¾ãŸã¯é©åˆ‡ãªIAMæ¨©é™ãŒå¿…è¦

3. **ãƒã‚±ãƒƒãƒˆåé‡è¤‡**
   - S3ãƒã‚±ãƒƒãƒˆåã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDã‚’å«ã‚ã¦ã„ã‚‹ãŸã‚é€šå¸¸ã¯å›é¿å¯èƒ½

4. **GitHub Actionsæ¨©é™ã‚¨ãƒ©ãƒ¼**
   - OIDC ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
   - ãƒªãƒã‚¸ãƒˆãƒªåã®åˆ¶é™ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

### ãƒ‡ãƒãƒƒã‚°

```bash
# CDKãƒ­ã‚°æœ‰åŠ¹åŒ–
export CDK_DEBUG=true
npx cdk deploy -c env=dev --verbose
```

## ğŸ“š å‚è€ƒãƒªãƒ³ã‚¯

- [AWS CDK Developer Guide](https://docs.aws.amazon.com/cdk/)
- [AWS CDK API Reference](https://docs.aws.amazon.com/cdk/api/v2/)
- [GitHub Actions OIDC](https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect)

## ğŸ¤ ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³

1. ç’°å¢ƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã®è¦‹ç›´ã—
3. ã‚³ã‚¹ãƒˆæœ€é©åŒ–ã®ææ¡ˆ
4. ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆã®è¿½åŠ 
